<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Room - Pro Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background: #f0f2f5; 
        color: #333; 
        overflow: hidden; 
        display: flex; 
        height: 100vh;
        /* Theme Transition */
        transition: background 0.5s ease, color 0.5s ease;
    }
    
    /* SIDEBAR */
    #sidebar {
      width: 260px; background: white; border-right: 1px solid #ddd;
      display: flex; flex-direction: column; transition: background 0.5s ease;
      z-index: 110;
    }
    .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    #memberList { flex: 1; overflow-y: auto; padding: 10px; }
    .member-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; margin-bottom: 5px; font-size: 14px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
    .status-dot.online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
    
    /* MAIN CHAT */
    #mainContent { flex: 1; display: flex; flex-direction: column; position: relative; }
    
    .header {
      height: 60px; background: white; border-bottom: 1px solid #ddd;
      display: flex; align-items: center; padding: 0 20px; z-index: 100;
      transition: background 0.5s ease;
    }
    
    .admin-btn { padding: 6px 12px; border-radius: 4px; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 11px; margin-left: 5px; display: none; }
    #clearBtn { background: #ff4757; }
    #settingsBtn { background: #2f3542; }

    /* ANIMATED GRADIENT KEYFRAMES */
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* CLEAR CHAT ANIMATION */
    .fade-out {
        opacity: 0;
        transform: scale(0.9);
        transition: all 0.6s ease;
    }

    #chatBox { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    
    .message { padding: 12px 16px; border-radius: 15px; max-width: 65%; position: relative; line-height: 1.4; transition: opacity 0.3s ease; }
    .message.own { align-self: flex-end; background: #4285f4; color: white; border-bottom-right-radius: 2px; }
    .message.other { align-self: flex-start; background: white; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    .admin-bubble { background-size: 200% 200% !important; border: 1px solid rgba(255,255,255,0.3); }
    .admin-animated { animation: gradientBG 3s ease infinite !important; }

    /* TOOLTIP LOGIC */
    .message-user { font-size: 11px; font-weight: 800; margin-bottom: 4px; position: relative; cursor: help; display: inline-block; }
    .admin-tooltip {
        visibility: hidden; position: absolute; bottom: 120%; left: 0; 
        background: #222; color: white; padding: 8px; border-radius: 6px;
        white-space: nowrap; font-size: 10px; z-index: 1000; opacity: 0;
        transition: opacity 0.2s ease; pointer-events: auto;
    }
    .message-user:hover .admin-tooltip { visibility: visible; opacity: 1; }

    .delete-btn { color: rgba(255,255,255,0.6); cursor: pointer; font-size: 14px; margin-left: 8px; }

    #inputArea { height: 80px; background: white; border-top: 1px solid #ddd; padding: 15px; display: flex; gap: 10px; transition: background 0.5s ease; }
    #messageInput { flex: 1; border-radius: 25px; border: 1px solid #ddd; padding: 0 20px; outline: none; background: #f1f2f6; }
    #sendBtn { background: #4285f4; color: white; border: none; border-radius: 50%; width: 50px; cursor: pointer; font-weight: bold; }

    /* DARK MODE */
    body.dark-mode, body.dark-mode #sidebar, body.dark-mode .header, body.dark-mode #inputArea { background: #18191a; color: #e4e6eb; border-color: #3e4042; }
    body.dark-mode .message.other { background: #242526; color: #e4e6eb; }
    body.dark-mode #messageInput { background: #3a3b3c; color: white; border: none; }
  </style>
</head>
<body>

  <div id="sidebar">
    <div class="sidebar-header">Members <span id="onlineCount">0</span></div>
    <div id="memberList"></div>
  </div>

  <div id="mainContent">
    <div class="header">
      <button onclick="window.location.href='index.html'" style="padding:5px 10px">Back</button>
      <button onclick="toggleTheme()" id="themeBtn" style="margin-left:10px; border:none; background:none; cursor:pointer; font-size:18px">ðŸŒ™</button>
      <button id="clearBtn" class="admin-btn" onclick="clearChat()">Clear Chat</button>
      <button id="settingsBtn" class="admin-btn" onclick="document.getElementById('adminModal').style.display='block'">âš™ Admin Styles</button>
      
      <div style="margin-left:auto; display:flex; align-items:center; gap:10px">
        <span id="uName"></span>
        <div id="uAvatar" style="width:30px; height:30px; background:#4285f4; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold">U</div>
      </div>
    </div>

    <div id="chatBox"></div>
    <div id="typingIndicator" style="padding:5px 20px; font-size:12px; height:20px; color:#888"></div>

    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="Message..." autocomplete="off">
      <button id="sendBtn" onclick="sendMsg()">></button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, onChildAdded, update, remove, serverTimestamp, onDisconnect, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN8ypq4TxhLwjseqnDJneBO2j_BlARz0M",
      authDomain: "chat-or-somethig.firebaseapp.com",
      databaseURL: "https://chat-or-somethig-default-rtdb.firebaseio.com",
      projectId: "chat-or-somethig"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    let user = null, isAdmin = false, myStyles = {};

    // --- FIX: Typing Function ---
    window.handleTyping = () => {
      if(!user) return;
      const tRef = ref(db, `typing/${user.uid}`);
      set(tRef, document.getElementById('uName').textContent);
      setTimeout(() => remove(tRef), 2000);
    };

    document.getElementById('messageInput').addEventListener('input', window.handleTyping);

    onAuthStateChanged(auth, u => {
      if(!u) return;
      user = u;
      
      const pRef = ref(db, `presence/${u.uid}`);
      set(pRef, true);
      onDisconnect(pRef).remove();

      onValue(ref(db, `users/${u.uid}`), s => {
        const data = s.val() || {};
        isAdmin = data.isAdmin || false;
        myStyles = { g1: data.g1, g2: data.g2, nc: data.nc, anim: data.anim };
        
        document.getElementById('uName').textContent = data.username || user.email.split('@')[0];
        if(isAdmin) document.querySelectorAll('.admin-btn').forEach(b => b.style.display='block');
        if(data.theme === 'dark') document.body.classList.add('dark-mode');
      });

      loadMembers();
      loadMessages();
    });

    // --- Animation: Clear Chat ---
    window.clearChat = () => {
        if(!confirm("Clear everything?")) return;
        const messages = document.querySelectorAll('.message');
        messages.forEach(m => m.classList.add('fade-out'));
        
        setTimeout(() => {
            set(ref(db, 'messages'), null);
            document.getElementById('chatBox').innerHTML = "";
        }, 6000); // Allow time for animation
    };

    window.toggleTheme = () => {
      const isDark = document.body.classList.toggle('dark-mode');
      update(ref(db, `users/${user.uid}`), { theme: isDark ? 'dark' : 'light' });
    };

    function loadMessages() {
      const box = document.getElementById('chatBox');
      onChildAdded(ref(db, 'messages'), s => {
        const m = s.val();
        const isOwn = m.userId === user.uid;
        const div = document.createElement('div');
        div.className = `message ${isOwn?'own':'other'} ${m.isAdminMsg?'admin-bubble':''}`;
        
        if(m.isAdminMsg) {
          div.style.background = `linear-gradient(45deg, ${m.g1}, ${m.g2})`;
          if(m.anim) div.classList.add('admin-animated');
        }

        const userWrap = document.createElement('div');
        userWrap.className = 'message-user';
        userWrap.style.color = m.nc || '';
        userWrap.textContent = isOwn ? 'You' : m.username;

        // Admin Hover Tooltip
        if(isAdmin && !isOwn) {
            const tip = document.createElement('div');
            tip.className = 'admin-tooltip';
            tip.innerHTML = `${m.email} <br> <button onclick="banUser('${m.userId}')" style="background:red; color:white; border:none; padding:2px 5px; border-radius:3px; cursor:pointer; margin-top:5px">BAN</button>`;
            userWrap.appendChild(tip);
        }

        div.appendChild(userWrap);
        const txt = document.createElement('div');
        txt.innerHTML = `${m.text} ${isOwn || isAdmin ? `<span class="delete-btn" onclick="del('${s.key}')">&times;</span>`:''}`;
        div.appendChild(txt);

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      });
    }

    // Rest of the logic (loadMembers, sendMsg, etc) stays the same
    window.sendMsg = () => {
      const input = document.getElementById('messageInput');
      if(!input.value.trim()) return;
      push(ref(db, 'messages'), {
        text: input.value,
        userId: user.uid,
        username: document.getElementById('uName').textContent,
        email: user.email,
        isAdminMsg: isAdmin,
        g1: myStyles.g1, g2: myStyles.g2, nc: myStyles.nc, anim: myStyles.anim,
        timestamp: serverTimestamp()
      });
      input.value = "";
    };

    function loadMembers() {
        onValue(ref(db, 'users'), uSnap => {
            onValue(ref(db, 'presence'), pSnap => {
                const members = uSnap.val() || {};
                const online = pSnap.val() || {};
                const list = document.getElementById('memberList');
                list.innerHTML = "";
                Object.keys(members).forEach(uid => {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.innerHTML = `<div class="status-dot ${online[uid]?'online':''}"></div><span>${members[uid].username || 'User'}</span>`;
                    list.appendChild(item);
                });
            });
        });
    }

    window.del = (id) => remove(ref(db, `messages/${id}`));
    document.getElementById('messageInput').addEventListener('keypress', e => { if(e.key==='Enter') sendMsg(); });
  </script>
</body>
</html>
