<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Room - Admin Pro Fixed</title>
  <style>
    /* ... (Keeping your existing styles for brevity, adding the Mute notification style) ... */
    .mute-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); color: white; display: none;
        flex-direction: column; align-items: center; justify-content: center; z-index: 3000;
    }
    /* Simple CSS for the Tooltip Ban Button */
    .ban-btn-tip {
        background: #ff4757; color: white; border: none; padding: 4px 8px;
        border-radius: 4px; cursor: pointer; margin-top: 5px; font-weight: bold;
    }
    .ban-btn-tip:hover { background: #ff6b81; }
    
    /* Re-adding essential layout styles from previous version */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; display: flex; height: 100vh; transition: 0.5s; }
    #sidebar { width: 260px; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
    #mainContent { flex: 1; display: flex; flex-direction: column; }
    #chatBox { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .message { padding: 10px 15px; border-radius: 15px; max-width: 70%; position: relative; }
    .message.own { align-self: flex-end; background: #4285f4; color: white; }
    .message.other { align-self: flex-start; background: #e4e6eb; }
    .admin-btn { display: none; padding: 5px 10px; margin-left: 5px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="muteNotice" class="mute-overlay">
    <h1>ðŸš« YOU ARE MUTED</h1>
    <p id="muteTimeLeft">Wait for the admin to unmute you.</p>
  </div>

  <div id="sidebar">
    <div style="padding:20px; border-bottom:1px solid #eee;">Online: <span id="onlineCount">0</span></div>
    <div id="memberList" style="flex:1; overflow-y:auto; padding:10px;"></div>
  </div>

  <div id="mainContent">
    <div style="height:60px; display:flex; align-items:center; padding:0 20px; border-bottom:1px solid #ddd;">
      <button id="clearBtn" class="admin-btn" style="background:red; color:white;" onclick="clearChat()">CLEAR ALL</button>
      <button id="settingsBtn" class="admin-btn" onclick="openAdminSettings()">âš™ STYLES</button>
      <span id="uNameDisplay" style="margin-left:auto; font-weight:bold;"></span>
    </div>

    <div id="chatBox"></div>
    <div id="typingIndicator" style="height:20px; padding:0 20px; font-size:12px; color:gray;"></div>

    <div style="height:70px; padding:15px; display:flex; gap:10px; border-top:1px solid #ddd;">
      <input type="text" id="messageInput" placeholder="Type..." style="flex:1; border-radius:20px; padding:0 15px;">
      <button onclick="sendMsg()" style="padding:0 20px;">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, onChildAdded, update, remove, serverTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN8ypq4TxhLwjseqnDJneBO2j_BlARz0M",
      authDomain: "chat-or-somethig.firebaseapp.com",
      databaseURL: "https://chat-or-somethig-default-rtdb.firebaseio.com",
      projectId: "chat-or-somethig"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let user = null, isAdmin = false, myStyles = {};

    // --- ADMIN ACTION: BAN ---
    window.banUser = (targetUid) => {
      if(!isAdmin) return;
      if(confirm("Are you sure you want to BAN this user?")) {
        update(ref(db, `users/${targetUid}`), { isBanned: true })
          .then(() => alert("User Banned."));
      }
    };

    // --- ADMIN ACTION: MUTE ---
    window.muteUser = (targetUid) => {
      if(!isAdmin) return;
      const duration = prompt("Mute duration in minutes:", "5");
      if(duration) {
        const until = Date.now() + (parseInt(duration) * 60000);
        update(ref(db, `users/${targetUid}`), { mutedUntil: until });
      }
    };

    onAuthStateChanged(auth, u => {
      if(!u) return;
      user = u;
      
      onValue(ref(db, `users/${u.uid}`), s => {
        const d = s.val() || {};
        isAdmin = d.isAdmin === true;
        
        // CHECK BAN STATUS
        if(d.isBanned) {
            document.body.innerHTML = "<h1 style='text-align:center; margin-top:100px;'>â›” YOU ARE PERMANENTLY BANNED</h1>";
            return;
        }

        // CHECK MUTE STATUS
        const now = Date.now();
        if(d.mutedUntil && d.mutedUntil > now) {
            document.getElementById('muteNotice').style.display = 'flex';
            document.getElementById('messageInput').disabled = true;
        } else {
            document.getElementById('muteNotice').style.display = 'none';
            document.getElementById('messageInput').disabled = false;
        }

        document.getElementById('uNameDisplay').textContent = d.username || "User";
        if(isAdmin) {
            document.getElementById('clearBtn').style.display = 'block';
            document.getElementById('settingsBtn').style.display = 'block';
        }
      });

      loadMessages();
      loadMembers();
    });

    function loadMessages() {
        const box = document.getElementById('chatBox');
        onChildAdded(ref(db, 'messages'), s => {
            const m = s.val();
            const isOwn = m.userId === user.uid;
            
            const div = document.createElement('div');
            div.className = `message ${isOwn?'own':'other'} ${m.isAdminMsg?'admin-bubble':''}`;
            
            if(m.isAdminMsg) {
                div.style.background = `linear-gradient(45deg, ${m.g1}, ${m.g2})`;
                if(m.anim) div.classList.add('admin-animated');
            }

            const nameTag = document.createElement('div');
            nameTag.className = 'message-user';
            nameTag.style.color = m.nc || (isOwn ? '#fff' : '#000');
            nameTag.textContent = isOwn ? "You" : m.username;

            // ADMIN TOOLTIP (Email + Ban + Mute)
            if(isAdmin && !isOwn) {
                const tip = document.createElement('div');
                tip.className = 'admin-tooltip';
                tip.innerHTML = `
                    <b>${m.email}</b><br>
                    <button class="ban-btn-tip" onclick="banUser('${m.userId}')">BAN</button>
                    <button class="ban-btn-tip" style="background:orange;" onclick="muteUser('${m.userId}')">MUTE</button>
                `;
                nameTag.appendChild(tip);
            }

            div.appendChild(nameTag);
            
            const text = document.createElement('div');
            text.innerHTML = `${m.text} ${isOwn || isAdmin ? `<span onclick="del('${s.key}')" style="cursor:pointer; margin-left:10px; opacity:0.5;">&times;</span>` : ''}`;
            div.appendChild(text);

            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });
    }

    // ... (rest of helper functions: del, clearChat, loadMembers, sendMsg) ...
    window.del = (id) => remove(ref(db, `messages/${id}`));
    window.clearChat = () => set(ref(db, 'messages'), null);

    function loadMembers() {
        onValue(ref(db, 'users'), uSnap => {
            onValue(ref(db, 'presence'), pSnap => {
                const members = uSnap.val() || {};
                const online = pSnap.val() || {};
                const list = document.getElementById('memberList');
                list.innerHTML = "";
                let count = 0;
                Object.keys(members).forEach(uid => {
                    if(online[uid]) count++;
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.innerHTML = `<div class="status-dot ${online[uid]?'online':''}"></div><span>${members[uid].username || 'User'}</span>`;
                    list.appendChild(item);
                });
                document.getElementById('onlineCount').textContent = count;
            });
        });
    }

    window.sendMsg = () => {
        const input = document.getElementById('messageInput');
        if(!input.value.trim() || input.disabled) return;
        push(ref(db, 'messages'), {
            text: input.value, userId: user.uid, email: user.email,
            username: document.getElementById('uNameDisplay').textContent,
            isAdminMsg: isAdmin, g1: myStyles.g1 || '#4285f4', g2: myStyles.g2 || '#9b51e0', 
            nc: myStyles.nc || '#ffffff', anim: myStyles.anim || false,
            timestamp: serverTimestamp()
        });
        input.value = "";
    };
  </script>
</body>
</html>
