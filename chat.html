<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Room - Pro Admin</title>
  <style>
    :root { --admin-grad: linear-gradient(45deg, #4285f4, #9b51e0); }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: #333; overflow: hidden; display: flex; height: 100vh; }
    
    /* SIDEBAR */
    #sidebar {
      width: 260px; background: white; border-right: 1px solid #ddd;
      display: flex; flex-direction: column; transition: transform 0.3s ease;
      z-index: 110;
    }
    .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    #memberList { flex: 1; overflow-y: auto; padding: 10px; }
    .member-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; margin-bottom: 5px; font-size: 14px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
    .status-dot.online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
    
    /* MAIN CHAT */
    #mainContent { flex: 1; display: flex; flex-direction: column; position: relative; }
    
    .header {
      height: 60px; background: white; border-bottom: 1px solid #ddd;
      display: flex; align-items: center; padding: 0 20px; z-index: 100;
    }
    
    .admin-btn { padding: 6px 12px; border-radius: 4px; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 11px; margin-left: 5px; display: none; }
    #clearBtn { background: #ff4757; }
    #settingsBtn { background: #2f3542; }

    /* ANIMATED GRADIENT KEYFRAMES */
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    #chatBox { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    
    .message { padding: 12px 16px; border-radius: 15px; max-width: 65%; position: relative; line-height: 1.4; }
    .message.own { align-self: flex-end; background: #4285f4; color: white; border-bottom-right-radius: 2px; }
    .message.other { align-self: flex-start; background: white; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* ADMIN BUBBLE STYLES */
    .admin-bubble { background-size: 200% 200% !important; border: 1px solid rgba(255,255,255,0.3); }
    .admin-animated { animation: gradientBG 3s ease infinite !important; }

    .message-user { font-size: 11px; font-weight: 800; margin-bottom: 4px; cursor: help; }
    .delete-btn { color: rgba(255,255,255,0.6); cursor: pointer; font-size: 14px; margin-left: 8px; }

    /* MODAL */
    .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 12px; z-index: 1000; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal h3 { margin-bottom: 15px; }
    .modal-row { margin-bottom: 15px; }
    .modal-row label { display: block; font-size: 12px; margin-bottom: 5px; }

    #inputArea { height: 80px; background: white; border-top: 1px solid #ddd; padding: 15px; display: flex; gap: 10px; }
    #messageInput { flex: 1; border-radius: 25px; border: 1px solid #ddd; padding: 0 20px; outline: none; background: #f1f2f6; }
    #sendBtn { background: #4285f4; color: white; border: none; border-radius: 50%; width: 50px; cursor: pointer; font-weight: bold; }

    /* DARK MODE */
    body.dark-mode, body.dark-mode #sidebar, body.dark-mode .header, body.dark-mode #inputArea, body.dark-mode .modal { background: #18191a; color: #e4e6eb; border-color: #3e4042; }
    body.dark-mode .message.other { background: #242526; color: #e4e6eb; }
    body.dark-mode #messageInput { background: #3a3b3c; color: white; border: none; }
  </style>
</head>
<body>

  <div id="sidebar">
    <div class="sidebar-header">Members <span id="onlineCount">0</span></div>
    <div id="memberList"></div>
  </div>

  <div id="mainContent">
    <div class="header">
      <button onclick="window.location.href='index.html'" style="padding:5px 10px">Back</button>
      <button onclick="toggleTheme()" id="themeBtn" style="margin-left:10px; border:none; background:none; cursor:pointer; font-size:18px">ðŸŒ™</button>
      <button id="clearBtn" class="admin-btn" onclick="clearChat()">Clear Chat</button>
      <button id="settingsBtn" class="admin-btn" onclick="document.getElementById('adminModal').style.display='block'">âš™ Admin Settings</button>
      
      <div style="margin-left:auto; display:flex; align-items:center; gap:10px">
        <span id="uName"></span>
        <div id="uAvatar" style="width:30px; height:30px; background:#4285f4; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold">U</div>
      </div>
    </div>

    <div id="chatBox"></div>
    <div id="typingIndicator" style="padding:5px 20px; font-size:12px; height:20px; color:#888"></div>

    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="Message..." oninput="handleTyping()">
      <button id="sendBtn" onclick="sendMsg()">></button>
    </div>
  </div>

  <div id="adminModal" class="modal">
    <h3>Admin Styles</h3>
    <div class="modal-row">
      <label>Gradient Color 1</label>
      <input type="color" id="grad1" value="#4285f4" style="width:100%">
    </div>
    <div class="modal-row">
      <label>Gradient Color 2</label>
      <input type="color" id="grad2" value="#9b51e0" style="width:100%">
    </div>
    <div class="modal-row">
      <label>Name Color</label>
      <input type="color" id="nameCol" value="#ffffff" style="width:100%">
    </div>
    <div class="modal-row">
      <label><input type="checkbox" id="isAnimated"> Enable Animation</label>
    </div>
    <button onclick="saveAdminStyles()" style="width:100%; padding:10px; background:#4285f4; color:white; border:none; border-radius:5px">Save & Close</button>
    <button onclick="document.getElementById('adminModal').style.display='none'" style="width:100%; margin-top:5px; background:none; border:none; cursor:pointer">Cancel</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, onChildAdded, update, remove, serverTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN8ypq4TxhLwjseqnDJneBO2j_BlARz0M",
      authDomain: "chat-or-somethig.firebaseapp.com",
      databaseURL: "https://chat-or-somethig-default-rtdb.firebaseio.com",
      projectId: "chat-or-somethig"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    let user = null, isAdmin = false, myStyles = {};

    onAuthStateChanged(auth, u => {
      if(!u) { window.location.href='index.html'; return; }
      user = u;
      
      // ONLINE PRESENCE
      const pRef = ref(db, `presence/${u.uid}`);
      set(pRef, true);
      onDisconnect(pRef).remove();

      onValue(ref(db, `users/${u.uid}`), s => {
        const data = s.val() || {};
        isAdmin = data.isAdmin || false;
        myStyles = {
          g1: data.g1 || '#4285f4',
          g2: data.g2 || '#9b51e0',
          nc: data.nc || '#ffffff',
          anim: data.anim || false
        };
        
        document.getElementById('uName').textContent = data.username || user.email.split('@')[0];
        document.getElementById('uAvatar').textContent = (data.username || 'U').charAt(0).toUpperCase();
        if(isAdmin) {
          document.querySelectorAll('.admin-btn').forEach(b => b.style.display='block');
        }
        if(data.theme === 'dark') document.body.classList.add('dark-mode');
      });

      loadMembers();
      loadMessages();
    });

    window.toggleTheme = () => {
      const isDark = document.body.classList.toggle('dark-mode');
      update(ref(db, `users/${user.uid}`), { theme: isDark ? 'dark' : 'light' });
    };

    window.saveAdminStyles = () => {
      update(ref(db, `users/${user.uid}`), {
        g1: document.getElementById('grad1').value,
        g2: document.getElementById('grad2').value,
        nc: document.getElementById('nameCol').value,
        anim: document.getElementById('isAnimated').checked
      });
      document.getElementById('adminModal').style.display='none';
    };

    function loadMembers() {
      onValue(ref(db, 'users'), uSnap => {
        onValue(ref(db, 'presence'), pSnap => {
          const members = uSnap.val() || {};
          const online = pSnap.val() || {};
          const list = document.getElementById('memberList');
          list.innerHTML = "";
          let count = 0;

          Object.keys(members).forEach(uid => {
            const isOnline = online[uid] ? true : false;
            if(isOnline) count++;
            const item = document.createElement('div');
            item.className = 'member-item';
            item.innerHTML = `
              <div class="status-dot ${isOnline?'online':''}"></div>
              <span>${members[uid].username || 'User'}</span>
              ${isAdmin && uid !== user.uid ? `<button onclick="banUser('${uid}')" style="font-size:9px; margin-left:auto">Ban</button>` : ''}
            `;
            list.appendChild(item);
          });
          document.getElementById('onlineCount').textContent = count;
        });
      });
    }

    function loadMessages() {
      const box = document.getElementById('chatBox');
      onChildAdded(ref(db, 'messages'), s => {
        const m = s.val();
        const isOwn = m.userId === user.uid;
        const div = document.createElement('div');
        div.className = `message ${isOwn?'own':'other'} ${m.isAdminMsg?'admin-bubble':''}`;
        
        if(m.isAdminMsg) {
          div.style.background = `linear-gradient(45deg, ${m.g1}, ${m.g2})`;
          if(m.anim) div.classList.add('admin-animated');
        }

        div.innerHTML = `
          <div class="message-user" style="color:${m.nc || ''}">${isOwn?'You':m.username}</div>
          <div class="message-text">${m.text} ${isOwn || isAdmin ? `<span class="delete-btn" onclick="del('${s.key}')">&times;</span>`:''}</div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      });
    }

    window.sendMsg = () => {
      const input = document.getElementById('messageInput');
      if(!input.value.trim()) return;
      push(ref(db, 'messages'), {
        text: input.value,
        userId: user.uid,
        username: document.getElementById('uName').textContent,
        isAdminMsg: isAdmin,
        g1: myStyles.g1,
        g2: myStyles.g2,
        nc: myStyles.nc,
        anim: myStyles.anim,
        timestamp: serverTimestamp()
      });
      input.value = "";
    };

    window.del = (id) => remove(ref(db, `messages/${id}`));
    window.clearChat = () => set(ref(db, 'messages'), null).then(()=>window.location.reload());
    
    document.getElementById('messageInput').addEventListener('keypress', e => { if(e.key==='Enter') sendMsg(); });
  </script>
</body>
</html>
